# 0.3 Amendment: Kill Fallback Plague

## 1. `run` signature → `input:` kwarg

```ruby
# Before
engine.run({ value: 21 })

# After
engine.run(input: { value: 21 })
```

**Files:**
- `lib/durable_workflow/core/engine.rb` - `def run(input, ...)` → `def run(input: {}, ...)`
- `lib/durable_workflow/runners/sync.rb` - `def run(input, ...)` → `def run(input: {}, ...)`
- `lib/durable_workflow/runners/sync.rb` - `def run_until_complete(input, ...)` → `def run_until_complete(input: {}, ...)`
- `lib/durable_workflow/runners/stream.rb` - same
- `lib/durable_workflow/runners/adapters/sidekiq.rb` - `engine.run(args[:input] || {}, ...)` → `engine.run(input: args[:input], ...)`
- `lib/durable_workflow/runners/adapters/inline.rb` - `engine.run(input || {}, ...)` → `engine.run(input:, ...)`

**Examples (update call sites):**
- `examples/order_fulfillment/run.rb:72` - `runner.run(order)` → `runner.run(input: order)`
- `examples/file_search_demo.rb:69` - `runner.run({ query: ... })` → `runner.run(input: { query: ... })`
- `examples/item_processor.rb:75` - `runner.run({...})` → `runner.run(input: {...})`
- `examples/calculator.rb:148` - `runner.run(input)` → `runner.run(input:)`
- `examples/approval_request.rb:94,99` - `runner.run({...})` → `runner.run(input: {...})`
- `examples/support_agent/run.rb:52` - `runner.run({...})` → `runner.run(input: {...})`
- `examples/service_integration.rb:125,130,135` - `runner.run({...})` → `runner.run(input: {...})`
- `examples/parallel_fetch.rb:96` - `runner.run({...})` → `runner.run(input: {...})`
- `examples/hello_workflow.rb:52` - `runner.run({...})` → `runner.run(input: {...})`

**Tests (update call sites):**
- `test/integration/workflow_test.rb:72,80,113,161,201,246,268`
- `test/unit/runners/async_test.rb:50,58,66,76,86,130`
- `test/unit/runners/sync_test.rb:78,88,97,107`
- `test/unit/runners/stream_test.rb:67,79,91,106,118,133,149`
- `test/unit/core/engine_test.rb:70,87,100,121,139,160,183,231,252,268`

---

## 2. Indifferent access util

Add `Utils.fetch(hash, key)` - kills `x[key.to_sym] || x[key.to_s]` pattern.

**Add to:**
- `lib/durable_workflow/utils.rb`

**Replace in:**
- `lib/durable_workflow/core/resolver.rb:49`
- `lib/durable_workflow/core/validator.rb:249,255`
- `lib/durable_workflow/core/executors/transform.rb:44`
- `lib/durable_workflow/extensions/ai/executors/mcp.rb:26,37`
- `lib/durable_workflow/extensions/ai/executors/agent.rb:110,111`
- `lib/durable_workflow/extensions/ai/mcp/adapter.rb:54,55`

---

## 3. dry-struct defaults

Add `.default()` to type attributes:

| Attribute | Default |
|-----------|---------|
| `files` | `[]` |
| `max_results` | `10` |
| `checks` | `[]` |
| `arguments` | `{}.freeze` |
| `data` | `{}` |
| `reason` | `"Halted"` |
| `wait` | `"all"` |
| `tools` | `[]` |
| `headers` | `{}.freeze` |
| `transport` | `:http` |

---

## 4. Remove dead fallbacks

After defaults are set, remove `|| {}` / `|| []` from:

- `lib/durable_workflow/core/executors/halt.rb:10,14,18`
- `lib/durable_workflow/core/executors/end.rb:11`
- `lib/durable_workflow/core/executors/loop.rb:91`
- `lib/durable_workflow/core/executors/parallel.rb:24`
- `lib/durable_workflow/extensions/ai/executors/file_search.rb:10,11`
- `lib/durable_workflow/extensions/ai/executors/mcp.rb:11`
- `lib/durable_workflow/extensions/ai/executors/agent.rb:59`
- `lib/durable_workflow/extensions/ai/executors/guardrail.rb:30,31`
- `lib/durable_workflow/extensions/ai/ai.rb:70,109,122,123,131,136,141`
